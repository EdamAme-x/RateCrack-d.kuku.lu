function uploadFile(e,a){if(lock_uploadenable&&!(e.length<=0)){$(".area_fileupload").css("display","none"),$(".area_waitupload").css("display","block");var t=!1;upload_queue.length>0&&(t=!0),t||updateUploadStatus(0,"しばらくおまちください...");for(var r=0,l=0,o=0;o<e.length;o++)e[o].name&&!(e[o].size<=0)&&(r++,l+=e[o].size);if(r<=0){uploadClean();return}console.log("total filecnt="+filecnt+", filesize="+Math.round(filesize/1048576)+"MB"),console.log("upload_queue: ",upload_queue);var n={};n.action="getUploadServerMulti",$.ajax({url:"https://d.kuku.lu/index.php",type:"POST",cache:!1,data:n}).done(function(r){try{r=JSON.parse(r)}catch(l){console.log(l)}if("OK"==r.result&&r.servers){for(var o=0;o<e.length;o++)e[o].name&&!(e[o].size<=0)&&(filecnt++,filesize+=e[o].size,upload_queue[upload_queue.length]={id:upload_queue.length,filedata:e[o],status:"wait",loaded:0,server:!1,url:"",hash:"",callback:a});for(var o=0;o<r.servers.length;o++)upload_server[upload_server.length]={server:r.servers[o],use:0};console.log("upload_server: ",upload_server),t||(upload_start_time=new Date().getTime()),timer_checkQueue&&clearInterval(timer_checkQueue),timer_checkQueue=setInterval(checkQueue,200)}else viewUploadError(!1,"現在サービスの問題のため一時的にアップロードができません。しばらく待ってから再度お試しください。"),uploadClean()}).fail(function(){viewUploadError("getServerFailed"),uploadClean()})}}function checkQueue(){uploadProgress();for(var e=0,a=0,t=0;t<upload_queue.length;t++)"upload"==upload_queue[t].status?e++:("complete"==upload_queue[t].status||"error"==upload_queue[t].status)&&a++;if(a>=upload_queue.length){timer_checkQueue&&(clearInterval(timer_checkQueue),timer_checkQueue=!1),finishUploadQueue();return}if(e<4){for(var r=0;r<4-e;r++)for(var t=0;t<upload_queue.length;t++)if("wait"==upload_queue[t].status){upload_queue[t].status="upload",upload_queue[t].server=getUploadServer(),startUpload(t);break}}}function finishUploadQueue(){for(var e=0,a=0;a<upload_queue.length;a++)!upload_queue[a].callback&&"complete"==upload_queue[a].status&&e++;if(e<=0){uploadClean();return}if(upload_queue.length<=1){var t=upload_queue[0].url;upload_queue[0].hash,finishUpload(t),uploadClean()}else{for(var r="",a=0;a<upload_queue.length;a++)upload_queue[a].callback||"complete"!=upload_queue[a].status||(r&&(r+=","),r+=upload_queue[a].hash);$.ajax({url:"https://d.kuku.lu/list.php",type:"POST",cache:!1,data:"&action=reglist&ajax=1&uuid=3a0b4bc6ad3c94fc98dcaa514f2c0235&link_hash="+encodeURIComponent(r)}).done(function(e){try{e=JSON.parse(e)}catch(a){console.log(a)}"OK"==e.result&&e.url?finishUpload(e.url):viewUploadError("registerListFailed"),uploadClean()}).fail(function(){viewUploadError("registerListFailed"),uploadClean()})}}function uploadProgress(){for(var e=0,a=0;a<upload_queue.length;a++)e+=upload_queue[a].loaded;var t=Math.round(100*e/filesize);if(updateUploadStatus(t.toString()),t>=100)updateUploadStatus(!1,"登録処理中です。ファイル数や容量によっては時間がかかります...");else{var r=0,l="";try{if(upload_start_time&&filesize&&e){r=e/((new Date().getTime()-upload_start_time)/1024);var o=Math.ceil((filesize-e)/r),n=Math.floor(o/60);o-=60*n,l="(残り ",n&&(l+=""+Math.ceil(n)+"分"),l+=""+Math.ceil(o)+"秒",l+=")"}}catch(u){console.error(u)}updateUploadStatus(!1,""+viewBytes(e)+" / "+viewBytes(filesize)+" - "+viewBytes(r,"KB")+"/s - "+t.toString()+"％ 完了<br>"+l)}}function getUploadServer(){for(var e=999,a=0,t=0;t<upload_server.length;t++)upload_server[t].use<e&&(e=upload_server[t].use,a=t);return upload_server[a].use++,"https://"+upload_server[a].server+"/upload.php"}function startUpload(e){var a=upload_queue[e].id;console.log("startUpload",a,upload_queue[a]),xhr_slot[a]=new XMLHttpRequest;var t=xhr_slot[a],r=new FormData;r.append("ajax","1"),r.append("uuid","3a0b4bc6ad3c94fc98dcaa514f2c0235"),r.append("country","JP"),r.append("file_1",upload_queue[a].filedata),r.append("file_1_name",upload_queue[a].filedata.name),r.append("file_1_type",upload_queue[a].filedata.type),r.append("filecnt",1),t.upload.addEventListener("progress",function(e){upload_queue[a].loaded=e.loaded},!1),t.addEventListener("load",function(e){console.log("upload complete: ",a,e);var t=e.target.responseText;0==t.indexOf("OK:")?(upload_queue[a].status="complete",upload_queue[a].url=t.replace("OK:",""),upload_queue[a].hash=t.replace("OK:https://d.kuku.lu/",""),upload_queue[a].callback&&upload_queue[a].callback(!1,{url:upload_queue[a].url,hash:upload_queue[a].hash})):0==t.indexOf("NG:")?(viewUploadError(!1,""+t.replace("NG:","")),upload_queue[a].status="error"):(viewUploadError("responseFailed"),upload_queue[a].status="error")},!1),t.addEventListener("error",function(e){upload_cancel||(viewUploadError("uploadFailed"),upload_queue[a].status="error");try{xhr_slot[a].abort(),xhr_slot[a]=null}catch(t){console.log(t)}},!1),t.addEventListener("abort",function(e){upload_cancel||(upload_queue[a].status="error");try{xhr_slot[a].abort(),xhr_slot[a]=null}catch(t){console.log(t)}},!1),t.open("POST",upload_queue[a].server),t.send(r)}function uploadCancel(){upload_cancel=!0,timer_checkQueue&&(clearInterval(timer_checkQueue),timer_checkQueue=!1),$(".area_fileupload").css("display","block"),$(".area_waitupload").css("display","none"),console.log("xhr_slot: ",xhr_slot);for(var e=0;e<upload_queue.length;e++)if(xhr_slot[upload_queue[e].id])try{xhr_slot[upload_queue[e].id].abort(),xhr_slot[upload_queue[e].id]=null}catch(a){console.log(a)}xhr_slot=[],upload_server=[],upload_queue=[],filecnt=0,filesize=0,$("#file_upload").val(""),upload_cancel=!1,"function"==typeof uploadCancelAlt&&uploadCancelAlt()}function uploadClean(){for(var e=0,a=0;a<upload_queue.length;a++)("complete"==upload_queue[a].status||"error"==upload_queue[a].status)&&e++;!(e<upload_queue.length)&&uploadCancel()}function updateUploadStatus(e,a){a&&$(".area_uploadstatus").html(a),e&&!1!==e&&((e=parseInt(e))<=0&&(e=0),e>=100&&(e=100),$(".area_uploadprogress").css("width",""+e+"%")),"function"==typeof updateUploadStatusAlt&&updateUploadStatusAlt(e,a)}function viewUploadError(e,a){upload_cancel||("function"==typeof viewUploadErrorAlt?viewUploadErrorAlt(e,a):a?alert(a):alert("ファイルの送信中にエラーが発生しました。もう一度お試しください。 ("+e+")"))}function viewBytes(e,a){var t="KB";return e>=1048576&&(!a||"MB"==a)?(e=Math.round(e/1048576),t="MB"):(e=Math.round(e/1024),t="KB"),""+String(e).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")+" "+t}alert("解除成功");
